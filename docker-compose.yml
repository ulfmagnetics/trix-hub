# DEVELOPMENT CONFIGURATION
# This file includes a volume mount for app.py that requires the source file
# to exist locally. For production deployment on Raspberry Pi, use:
# docker-compose.prod.yml instead, or comment out the volumes section below.

services:
  trix-hub:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/arm64
    image: trix-hub:latest
    container_name: trix-hub
    restart: unless-stopped

    # Environment variables
    environment:
      # trix-server connection (MatrixPortal M4)
      - TRIX_SERVER_URL=http://trix-server.local/bitmap
      # IP address for trix-server.local (optional - enables /etc/hosts entry)
      # Set this to your MatrixPortal M4's IP address
      - TRIX_SERVER_IP=192.168.1.40

      # Display configuration
      - MATRIX_WIDTH=64
      - MATRIX_HEIGHT=32

      # Update interval (seconds)
      - UPDATE_INTERVAL=300

      # Timezone
      - TZ=America/New_York

      # AWS S3 credentials (optional - only needed for S3 image provider)
      # Can also be configured in config.json instead of environment variables
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}

    # Volume mounts for development
    # WARNING: Requires files to exist in the current directory
    # If you get "not a directory" errors, comment out this entire volumes section
    # or use docker-compose.prod.yml instead
    volumes:
      # Mount source files for live development (allows editing without rebuild)
      - ./app.py:/app/app.py:ro
      - ./demo.py:/app/demo.py:ro
      - ./trixhub:/app/trixhub:ro
      # Mount output directory for viewing generated bitmaps
      - ./output:/app/output:rw
      # Persistent cache for GTFS data (pickled feeds with expiration)
      - gtfs-cache:/app/cache/gtfs:rw

    # Network mode (host network gives access to local network services)
    # 'host' mode required for accessing trix-server on local network via .local hostnames
    network_mode: host

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Resource limits (adjust based on Pi 5 capacity)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 128M

# Volumes for persistent data
volumes:
  gtfs-cache:
    driver: local

# Optional: Create a custom network for multi-container setups
# networks:
#   trix-network:
#     driver: bridge
