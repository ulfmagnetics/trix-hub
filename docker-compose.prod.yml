# Production configuration for Raspberry Pi 5
# Use this when deploying the pre-built Docker image to the Pi
# The app.py file is already baked into the image, no volume mounts needed

services:
  trix-hub:
    image: trix-hub:latest
    pull_policy: never  # Use locally loaded image, don't try to pull from Docker Hub
    container_name: trix-hub
    restart: unless-stopped

    # Environment variables
    environment:
      # trix-server connection (MatrixPortal M4)
      - TRIX_SERVER_URL=http://trix-server.local/bitmap
      # IP address for trix-server.local (optional - enables /etc/hosts entry)
      # Set this to your MatrixPortal M4's IP address
      - TRIX_SERVER_IP=192.168.1.40

      # Display configuration
      - MATRIX_WIDTH=64
      - MATRIX_HEIGHT=32

      # Update interval (seconds)
      - UPDATE_INTERVAL=300

      # Timezone
      - TZ=America/New_York

      # AWS S3 credentials (optional - only needed for S3 image provider)
      # Can also be configured in config.json instead of environment variables
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}

    # Persistent cache for GTFS data
    volumes:
      - gtfs-cache:/app/cache/gtfs:rw

    # Network mode (host network gives access to local network services)
    # 'host' mode required for accessing trix-server on local network via .local hostnames
    network_mode: host

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Resource limits (adjust based on Pi 5 capacity)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 128M

# Volumes for persistent data
volumes:
  gtfs-cache:
    driver: local
